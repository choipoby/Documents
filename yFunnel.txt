
------------
Sep 19, 2015

Sekwon item
- load balancer
- SSL
- DB migration :
	현재 아마존 PostgreSQL
	이걸 우리 머신으로 옮기는 작업

-----------
Oct 7, 2015


h2. load balancer configuration
h3. overview
- yfunnel03 as a HTTPS termination point.
- this server will be seen as a reverse proxy.
h3. load balancing method
- suggest ip_hash to persiste the session
h3. redirection of http traffic
- all clear traffic of http:// will be redirected to https://
h3. settings
{code}
@ /etc/nginx/sites-available/yfunnel.com
upstream yfunnelApp {
	ip_hash;
	server srv1.yfunnel.com;
	server srv2.yfunnel.com;
	server srv3.yfunnel.com;
}

server {
       listen         80;
       server_name    yfunnel.com www.yfunnel.com;
       return         301 https://$server_name$request_uri;
}

server {
       listen         		 443 ssl;
			 server_name    		 www.yfunnel.com;

			 ssl 								 on;
       ssl_certificate     www.yfunnel.com.crt;
			 ssl_certificate_key www.yfunnel.com.key;

			 ssl_prefer_server_ciphers       on;
			 ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
			 ssl_ciphers         HIGH:!aNULL:!MD5;

			 ssl_session_cache 	 shared:SSL:20m;
			 ssl_session_timeout 10m;

			 location / {
			 		proxy_pass http://yfunnelApp;
					proxy_set_header Host $host;
					proxy_set_header X-Real-IP $remote_addr;
					proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
					proxy_set_header X-Forwarded-Proto $scheme;
			}

       [....]
}
{code}

h2. Web application server configuration
h3. overview
- communication between load balancer and web application server is not encrypted.
- Web application server restrict HTTP access to the load balancer's private IP by firewall rules
{code}
iptables -I INPUT -m state --state NEW -p tcp --dport 80 ! -s 10.xx.xx.xx -j DROP
{code}

h2. Static content / User uploaded content
h3. CDN setting
- In case we don't use S3 (which we may consider using S3 in the long run), to save the cost for now, we can use our server as CDN and set it as a static content server as well as cache server.
- configure nginx for cdn
{code}
server {
  listen 80;
  server_name cdn.yfunnel.com;

  location / {
    expires 90d;
    root /var/www/assets/;
  }
}
{code}

To access content at CDN from application server, see below
http://idiallo.com/blog/file-sharing-on-ubuntu-web-server?rel=159


Log server
TBD
reference)
https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-load-balancing-with-ssl-termination
